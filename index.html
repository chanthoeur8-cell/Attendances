<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <title>Staff Attendance System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial,"Noto Sans Khmer",sans-serif; background:#f0f2f5; display:flex; justify-content:center; padding: 20px; }
        .card { background:#fff; width:100%; max-width:400px; padding:25px; border-radius:15px; box-shadow:0 8px 30px rgba(0,0,0,0.1); }
        h2 { text-align:center; color: #2563eb; margin-bottom: 20px; }
        label { font-size:14px; font-weight: bold; display: block; margin-top: 10px; }
        input, select, textarea { width:100%; padding:12px; margin-top:5px; border-radius:8px; border:1px solid #ddd; box-sizing: border-box; font-size:15px; }
        .time-box { background:#eef2ff; padding:15px; border-radius:10px; text-align:center; font-weight:bold; margin: 15px 0; color: #2563eb; border: 1px solid #c7d2fe; }
        button { width:100%; padding:15px; background:#2563eb; color:#fff; border:none; border-radius:10px; font-size:16px; font-weight:bold; cursor:pointer; margin-top: 10px; }
        button:hover { background: #1d4ed8; }
        #qrcode { display:flex; justify-content:center; margin-top:20px; }
        #reasonField { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“‹ á€ááŸ‹áœááŸ’áá˜á¶á“á”á»á‚áŸ’á‚á›á·á€</h2>
    
    <label>áˆáŸ’á˜áŸ„áŸ‡á–áŸá‰</label>
    <input id="name" type="text" placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á”á»á‚áŸ’á‚á›á·á€">
    
    <label>áá½á“á¶á‘á¸</label>
    <input id="role" type="text" placeholder="á”á‰áŸ’á…á¼á›áá½á“á¶á‘á¸">
    
    <label>á”áŸ’ášá—áŸá‘áœááŸ’áá˜á¶á“</label>
    <select id="type" onchange="checkTimeStatus()">
        <option value="checkin">Check-In (á…á¼á›á’áŸ’áœá¾á€á¶áš)</option>
        <option value="checkout">Check-Out (á…áŸá‰á–á¸á’áŸ’áœá¾á€á¶áš)</option>
    </select>

    <div class="time-box" id="timeDisplay">ğŸ•’ 00:00:00 | ğŸ“… 01/01/2026</div>

    <div id="reasonField">
        <label style="color:red;" id="reasonLabel">âš ï¸ á˜á¼á›á áŸáá»á™áºá/á…áŸá‰á˜á»á“</label>
        <textarea id="reason" placeholder="áŸá¼á˜á”á‰áŸ’á‡á¶á€áŸ‹á˜á¼á›á áŸáá»..."></textarea>
    </div>

    <button onclick="handleAttendance()">á”á‰áŸ’á‡á¼á“á‘á·á“áŸ’á“á“áŸá™ & á”á„áŸ’á€á¾á QR</button>

    <div id="qrcode"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
async function processAttendance() {
    const name = document.getElementById("name").value.trim();
    const role = document.getElementById("role").value.trim();
    const type = document.getElementById("type").value;
    const reason = document.getElementById("reason").value.trim();
    const {time, date} = getNow();

    if(!name || !role) {
        alert("áŸá¼á˜á”áŸ†á–áŸá‰áˆáŸ’á˜áŸ„áŸ‡ á“á·á„áá½á“á¶á‘á¸!");
        return;
    }

    // áŸ¡. á‚áá“á¶á“á¶á‘á¸á™áºá á¬ á…áŸá‰á˜á»á“ (á‘áŸ„áŸ‡á™áºáá€áŸáŠáŸ„á™ á€áŸá¢á“á»á‰áŸ’á‰á¶áá±áŸ’á™á•áŸ’á‰á¾)
    let extraDetail = "";
    if (type === "checkin") {
        const lateMins = getDiffMinutes(time, OFFICIAL_IN, true);
        if (lateMins > 0) {
            extraDetail = `\nâ° <b>á™áºááŸ–</b> ${lateMins} á“á¶á‘á¸`;
        } else {
            extraDetail = `\nâœ… <b>á˜á€á‘á¶á“áŸ‹á–áŸá›</b>`;
        }
    } else {
        const earlyMins = getDiffMinutes(time, OFFICIAL_OUT, false);
        if (earlyMins > 0) {
            extraDetail = `\nğŸƒ <b>á…áŸá‰á˜á»á“áŸ–</b> ${earlyMins} á“á¶á‘á¸`;
        }
    }

    // áŸ¢. ášáŸ€á”á…áŸ†áŸá¶ášáŸá˜áŸ’ášá¶á”áŸ‹ Telegram
    let message = `ğŸ”” <b>ášá”á¶á™á€á¶ášááŸáœááŸ’áá˜á¶á“</b>\n` +
                    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                    `ğŸ‘¤ <b>áˆáŸ’á˜áŸ„áŸ‡:</b> ${name}\n` +
                    `ğŸ’¼ <b>áá½á“á¶á‘á¸:</b> ${role}\n` +
                    `ğŸ“ <b>áŸáŸ’áá¶á“á—á¶á–:</b> ${type === 'checkin' ? 'âœ… Check-In' : 'ğŸšª Check-Out'}\n` +
                    `ğŸ•’ <b>á˜áŸ‰áŸ„á„:</b> ${time}${extraDetail}\n` +
                    `ğŸ“… <b>ááŸ’á„áŸƒá‘á¸:</b> ${date}\n` +
                    (reason ? `ğŸ’¬ <b>á˜á¼á›á áŸáá»:</b> ${reason}\n` : "") +
                    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;

    // áŸ£. á”á„áŸ’á€á¾á QR Code
    document.getElementById("qrcode").innerHTML = "";
    new QRCode(document.getElementById("qrcode"), { 
        text: message.replace(/<[^>]*>/g, ''), 
        width: 180, 
        height: 180 
    });

    // áŸ¤. á•áŸ’á‰á¾á‘áŸ… Telegram (á”áŸ’ášá¾ Fetch API)
    try {
        const response = await fetch(`https://t.me/my_staff_att_2026_bot${BOT_TOKEN}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                chat_id: CHAT_ID,
                text: message,
                parse_mode: "HTML"
            })
        });

        if (response.ok) {
            alert("âœ… áœááŸ’áá˜á¶á“ááŸ’ášá¼áœá”á¶á“á€ááŸ‹ááŸ’ášá¶á‡áŸ„á‚á‡áŸá™!");
        } else {
            const errData = await response.json();
            alert("âŒ Telegram Error: " + errData.description);
        }
    } catch (error) {
        alert("âŒ Error: á˜á·á“á¢á¶á…á—áŸ’á‡á¶á”áŸ‹á‘áŸ… Telegram á”á¶á“á‘áŸ!");
    }
}
</script>
</body>
</html>


