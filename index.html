<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <title>Staff Attendance System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial,"Noto Sans Khmer",sans-serif; background:#f0f2f5; display:flex; justify-content:center; padding: 20px; }
        .card { background:#fff; width:100%; max-width:400px; padding:25px; border-radius:15px; box-shadow:0 8px 30px rgba(0,0,0,0.1); }
        h2 { text-align:center; color: #2563eb; margin-bottom: 20px; }
        label { font-size:14px; font-weight: bold; display: block; margin-top: 10px; }
        input, select, textarea { width:100%; padding:12px; margin-top:5px; border-radius:8px; border:1px solid #ddd; box-sizing: border-box; font-size:15px; }
        .time-box { background:#eef2ff; padding:15px; border-radius:10px; text-align:center; font-weight:bold; margin: 15px 0; color: #2563eb; border: 1px solid #c7d2fe; }
        button { width:100%; padding:15px; background:#2563eb; color:#fff; border:none; border-radius:10px; font-size:16px; font-weight:bold; cursor:pointer; margin-top: 10px; }
        button:hover { background: #1d4ed8; }
        #qrcode { display:flex; justify-content:center; margin-top:20px; }
        #reasonField { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“‹ á€ááŸ‹áœááŸ’áá˜á¶á“á”á»á‚áŸ’á‚á›á·á€</h2>
    
    <label>áˆáŸ’á˜áŸ„áŸ‡á–áŸá‰</label>
    <input id="name" type="text" placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á”á»á‚áŸ’á‚á›á·á€">
    
    <label>áá½á“á¶á‘á¸</label>
    <input id="role" type="text" placeholder="á”á‰áŸ’á…á¼á›áá½á“á¶á‘á¸">
    
    <label>á”áŸ’ášá—áŸá‘áœááŸ’áá˜á¶á“</label>
    <select id="type" onchange="checkTimeStatus()">
        <option value="checkin">Check-In (á…á¼á›á’áŸ’áœá¾á€á¶áš)</option>
        <option value="checkout">Check-Out (á…áŸá‰á–á¸á’áŸ’áœá¾á€á¶áš)</option>
    </select>

    <div class="time-box" id="timeDisplay">ğŸ•’ 00:00:00 | ğŸ“… 01/01/2026</div>

    <div id="reasonField">
        <label style="color:red;" id="reasonLabel">âš ï¸ á˜á¼á›á áŸáá»á™áºá/á…áŸá‰á˜á»á“</label>
        <textarea id="reason" placeholder="áŸá¼á˜á”á‰áŸ’á‡á¶á€áŸ‹á˜á¼á›á áŸáá»..."></textarea>
    </div>

    <button onclick="handleAttendance()">á”á‰áŸ’á‡á¼á“á‘á·á“áŸ’á“á“áŸá™ & á”á„áŸ’á€á¾á QR</button>

    <div id="qrcode"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const BOT_TOKEN = "8242266919:AAGE6uMJ_-UvM-3KBZkJVFhJyTLvcTVW5tQ";
const CHAT_ID = "1346632543";
// á€áŸ†áááŸ‹á˜áŸ‰áŸ„á„á…á¼á› á“á·á„ á…áŸá‰á•áŸ’á›á¼áœá€á¶áš
const OFFICIAL_IN = "07:15";
const OFFICIAL_OUT = "17:15";

async function processAttendance() {
    const name = document.getElementById("name").value.trim();
    const role = document.getElementById("role").value.trim();
    const type = document.getElementById("type").value; // 'checkin' á¬ 'checkout'
    const reason = document.getElementById("reason").value.trim();
    const {time, date} = getNow();

    if(!name || !role){
        alert("áŸá¼á˜á”áŸ†á–áŸá‰áˆáŸ’á˜áŸ„áŸ‡ á“á·á„ áá½á“á¶á‘á¸");
        return;
    }

    let statusLabel = "";
    let extraDetail = "";

    // --- á•áŸ’á“áŸ‚á€á–á·á“á·ááŸ’á™ Check-in ---
    if (type === "checkin") {
        statusLabel = "âœ… á…á¼á›á’áŸ’áœá¾á€á¶áš (Check-In)";
        const lateMins = getDiffMinutes(time, OFFICIAL_IN, true);
        if (lateMins > 0) {
            extraDetail = `\nâ° <b>á™áºááŸ–</b> ${lateMins} á“á¶á‘á¸`;
        }
    } 
    // --- á•áŸ’á“áŸ‚á€á–á·á“á·ááŸ’á™ Check-out ---
    else if (type === "checkout") {
        statusLabel = "ğŸšª á…áŸá‰á–á¸á’áŸ’áœá¾á€á¶áš (Check-Out)";
        const earlyMins = getDiffMinutes(time, OFFICIAL_OUT, false);
        if (earlyMins > 0) {
            extraDetail = `\nğŸƒ <b>á…áŸá‰á˜á»á“áŸ–</b> ${earlyMins} á“á¶á‘á¸`;
        }
    }

    // áŸ¡. ášáŸ€á”á…áŸ†áŸá¶ášáŸá˜áŸ’ášá¶á”áŸ‹ Telegram
    let displayText = `ğŸ”” <b>ášá”á¶á™á€á¶ášááŸáœááŸ’áá˜á¶á“</b>\n`;
    displayText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    displayText += `ğŸ‘¤ <b>áˆáŸ’á˜áŸ„áŸ‡:</b> ${name}\n`;
    displayText += `ğŸ’¼ <b>áá½á“á¶á‘á¸:</b> ${role}\n`;
    displayText += `ğŸ“ <b>áŸáŸ’áá¶á“á—á¶á–:</b> ${statusLabel}\n`;
    displayText += `ğŸ“… <b>ááŸ’á„áŸƒááŸ‚:</b> ${date}\n`;
    displayText += `ğŸ•’ <b>á˜áŸ‰áŸ„á„:</b> ${time}${extraDetail}\n`;
    
    if(reason) {
        displayText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        displayText += `âš ï¸ <b>á˜á¼á›á áŸáá»:</b> ${reason}\n`;
    }
    displayText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;

    // áŸ¢. á”á„áŸ’á€á¾á QR Code (á›á»á” tags HTML á…áŸá‰áŸá˜áŸ’ášá¶á”áŸ‹ QR)
    let qrText = displayText.replace(/<[^>]*>/g, '');
    document.getElementById("qrcode").innerHTML = "";
    new QRCode(document.getElementById("qrcode"), {
        text: qrText,
        width: 200,
        height: 200
    });

    // áŸ£. á•áŸ’á‰á¾á‘áŸ… Telegram
    sendToTelegram(displayText);
}

// Function á‡áŸ†á“á½á™áŸá˜áŸ’ášá¶á”áŸ‹á‚áá“á¶á“á¶á‘á¸
function getDiffMinutes(currentTime, limitTime, isLateCheck) {
    const [curH, curM] = currentTime.split(':').map(Number);
    const [limH, limM] = limitTime.split(':').map(Number);
    const curTotal = (curH * 60) + curM;
    const limTotal = (limH * 60) + limM;

    if (isLateCheck) {
        return curTotal > limTotal ? curTotal - limTotal : 0;
    } else {
        return limTotal > curTotal ? limTotal - curTotal : 0;
    }
}
</script>
</body>
</html>

